// ============================================================================
// HUMANID.FI - ENTERPRISE PRODUCTION SCHEMA (POSTGRESQL)
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // <--- VOLVEMOS A LA LIGA MAYOR
  url      = env("DATABASE_URL")
}

// ----------------------------------------------------------------------------
// 1. ENUMS (REGLAS ESTRICTAS DE NEGOCIO)
// ----------------------------------------------------------------------------

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IdentityTier {
  GHOST
  INITIATE
  HUMAN
  SOVEREIGN
}

enum MarketStatus {
  ACTIVE
  PAUSED
  RESOLVED
  DISPUTED
}

enum TransactionStatus {
  PENDING_RELAY
  SUBMITTED
  CONFIRMED
  FAILED
}

enum ProposalStatus {
  PENDING
  VOTING
  APPROVED
  REJECTED
  CREATED
  RESOLVED
  CANCELLED
  EXECUTED
}

enum VoteChoice {
  FOR
  AGAINST
  ABSTAIN
}

enum FeeType {
  TRADING_FEE
  CREATION_FEE
  RESOLUTION_FEE
}

enum DistributionStatus {
  PENDING
  PUBLISHED
  EXPIRED
  ARCHIVED
}

enum ZapStatus {
  PENDING
  SWAPPING
  BUYING
  COMPLETED
  FAILED
  PARTIAL_FAIL
}

// ----------------------------------------------------------------------------
// 2. USERS (See updated model below with NextAuth support)
// ----------------------------------------------------------------------------

// ----------------------------------------------------------------------------
// 2.1. SESSIONS (Security & Authentication)
// ----------------------------------------------------------------------------

model Session {
  id            String    @id @default(cuid())
  userId        String?
  user          User?     @relation(fields: [userId], references: [walletAddress], onDelete: Cascade)
  authUserId    String?
  authUser      AuthUser? @relation(fields: [authUserId], references: [id], onDelete: Cascade)

  sessionToken String  @unique
  accessToken  String?
  refreshToken String?

  expiresAt     DateTime
  createdAt     DateTime @default(now())
  lastActivity  DateTime @default(now())
  ipAddress     String?
  userAgent     String?
  fingerprint   String? // [NEW] Browser fingerprint for session hijacking detection
  isCompromised Boolean @default(false) // [NEW] Flag for suspicious sessions

  // [NEW] Enhanced Session Tracking
  deviceType String? // mobile, desktop, tablet
  browser    String? // Chrome, Firefox, Safari
  os         String? // Windows, macOS, iOS, Android
  country    String? // Spain, USA, etc
  city       String? // Madrid, New York, etc
  latitude   Float?
  longitude  Float?

  @@index([userId])
  @@index([authUserId])
  @@index([expiresAt])
  @@index([sessionToken])
  @@index([fingerprint])
}

// ----------------------------------------------------------------------------
// 2.2. SECURITY MONITORING
// ----------------------------------------------------------------------------

model SecurityEvent {
  id        String   @id @default(cuid())
  type      String // 'LOGIN', 'LOGOUT', 'IP_CHANGE', 'FINGERPRINT_MISMATCH', 'RATE_LIMIT', 'BLOCKED', 'FAILED_LOGIN'
  userId    String?
  ipAddress String
  userAgent String?
  metadata  Json?
  severity  String // 'INFO', 'WARNING', 'CRITICAL'
  timestamp DateTime @default(now())

  @@index([type, timestamp])
  @@index([userId, timestamp])
  @@index([ipAddress, timestamp])
}

model BlockedIP {
  id        String    @id @default(cuid())
  ipAddress String    @unique
  reason    String
  blockedAt DateTime  @default(now())
  expiresAt DateTime?

  @@index([ipAddress])
}

// ----------------------------------------------------------------------------
// 3. DASHBOARD & FINANCE
// ----------------------------------------------------------------------------

model TreasurySnapshot {
  id                String   @id @default(cuid())
  date              DateTime @default(now())
  totalValueLocked  Decimal  @db.Decimal(18, 2) // PrecisiÃ³n financiera real
  circulatingSupply Decimal
  protocolRevenue   Decimal
  blockNumber       BigInt?
  txHash            String?
}

model IntelItem {
  id             String   @id @default(cuid())
  source         String
  title          String
  category       String   @default("FINANCE")
  url            String   @unique
  publishedAt    DateTime @default(now())
  sentimentScore Float?
  aiSummary      String?  @db.Text
  priority       String   @default("NORMAL")
  createdAt      DateTime @default(now())

  @@index([publishedAt])
}

// ----------------------------------------------------------------------------
// 4. MARKETS & TRADING
// ----------------------------------------------------------------------------

model Market {
  slug      String       @id
  question  String
  category  String
  status    MarketStatus @default(ACTIVE)
  endDate   DateTime
  volume    Decimal      @default(0)
  liquidity Decimal      @default(0)
  riskLevel RiskLevel    @default(LOW)
  trades    Trade[]
}

model Trade {
  id         String   @id @default(cuid())
  userWallet String
  marketSlug String
  amount     Decimal
  position   String
  timestamp  DateTime @default(now())

  user   User   @relation(fields: [userWallet], references: [walletAddress])
  market Market @relation(fields: [marketSlug], references: [slug])
}

// ----------------------------------------------------------------------------
// 5. GOVERNANCE
// ----------------------------------------------------------------------------

model MarketProposal {
  id                 String @id @default(cuid())
  question           String
  description        String @db.Text
  outcomes           Json // Postgres soporta JSON nativo
  resolutionCriteria String @db.Text
  category           String

  creatorAddress   String
  creator          User   @relation(fields: [creatorAddress], references: [walletAddress])
  creatorNullifier String @unique

  votesFor        Int @default(0)
  votesAgainst    Int @default(0)
  votingThreshold Int @default(100)

  status          ProposalStatus @default(PENDING)
  createdAt       DateTime       @default(now())
  votingEndsAt    DateTime
  approvedAt      DateTime?
  marketCreatedAt DateTime?

  proposalId   String? @unique
  polymarketId String? @unique
  conditionId  String?

  totalFeesAccrued  Decimal  @default(0) @db.Decimal(18, 6)
  lastRoyaltyUpdate DateTime @default(now())

  txStatus        TransactionStatus @default(PENDING_RELAY)
  txHash          String?           @unique
  onChainId       Int?              @unique
  executedAt      DateTime?
  executionTxHash String?

  votes     ProposalVote[]
  royalties RoyaltyAccrual[]

  @@index([status, votingEndsAt])
  @@index([creatorAddress])
}

model ProposalVote {
  id         String         @id @default(cuid())
  proposalId String
  proposal   MarketProposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  nullifierHash String
  voterAddress  String
  voter         User   @relation(fields: [voterAddress], references: [walletAddress])

  vote    VoteChoice
  votedAt DateTime   @default(now())

  merkleRoot        String
  proof             Json // Postgres soporta JSON nativo
  verificationLevel String  @default("orb")
  ipfsHash          String?

  txHash       String?
  txStatus     TransactionStatus @default(PENDING_RELAY)
  errorMessage String?

  @@unique([proposalId, nullifierHash])
  @@index([proposalId, votedAt])
}

model Vote {
  id         String @id @default(cuid())
  userWallet String
  user       User   @relation(fields: [userWallet], references: [walletAddress])
}

// ----------------------------------------------------------------------------
// 6. UTILITIES
// ----------------------------------------------------------------------------

model RoyaltyAccrual {
  id           String         @id @default(cuid())
  proposalId   String
  proposal     MarketProposal @relation(fields: [proposalId], references: [id])
  amount       Decimal        @db.Decimal(18, 6)
  feeType      FeeType
  txHash       String         @unique
  blockNumber  BigInt
  timestamp    DateTime       @default(now())
  merkleTreeId String?
  claimed      Boolean        @default(false)
  claimedAt    DateTime?
  claimTxHash  String?

  @@index([proposalId, timestamp])
}

model MerkleDistribution {
  id           String             @id @default(cuid())
  periodStart  DateTime
  periodEnd    DateTime
  merkleRoot   String             @unique
  totalAmount  Decimal            @db.Decimal(18, 6)
  ipfsHash     String
  treeData     Json // Postgres soporta JSON nativo
  totalClaims  Int                @default(0)
  totalClaimed Decimal            @default(0) @db.Decimal(18, 6)
  status       DistributionStatus @default(PENDING)
  publishedAt  DateTime?
  expiresAt    DateTime
  claims       RewardClaim[]

  @@index([periodEnd, status])
}

model RewardClaim {
  id             String             @id @default(cuid())
  merkleTreeId   String
  distribution   MerkleDistribution @relation(fields: [merkleTreeId], references: [id])
  claimerAddress String
  claimer        User               @relation(fields: [claimerAddress], references: [walletAddress])
  amount         Decimal            @db.Decimal(18, 6)
  merkleProof    Json // Postgres soporta JSON nativo
  leafIndex      Int
  claimedAt      DateTime           @default(now())
  txHash         String             @unique
  gasUsed        BigInt

  @@unique([merkleTreeId, claimerAddress])
}

model ZapTransaction {
  id             String    @id @default(cuid())
  userAddress    String
  user           User      @relation(fields: [userAddress], references: [walletAddress])
  wldAmount      Decimal   @db.Decimal(18, 6)
  wldPriceUSD    Decimal   @db.Decimal(18, 6)
  usdcReceived   Decimal   @db.Decimal(18, 6)
  slippage       Decimal   @db.Decimal(5, 4)
  dexUsed        String
  marketId       String
  outcomeIndex   Int
  sharesReceived Decimal   @db.Decimal(18, 6)
  txHash         String    @unique
  blockNumber    BigInt
  gasUsed        BigInt
  gasPaidBy      String
  status         ZapStatus
  errorMessage   String?
  initiatedAt    DateTime  @default(now())
  completedAt    DateTime?

  @@index([userAddress, initiatedAt])
}

model UserMetrics {
  id                    String   @id @default(cuid())
  userAddress           String   @unique
  user                  User     @relation(fields: [userAddress], references: [walletAddress])
  proposalsCreated      Int      @default(0)
  votescast             Int      @default(0)
  zapsExecuted          Int      @default(0)
  totalWLDZapped        Decimal  @default(0) @db.Decimal(18, 6)
  totalRoyaltiesEarned  Decimal  @default(0) @db.Decimal(18, 6)
  totalRoyaltiesClaimed Decimal  @default(0) @db.Decimal(18, 6)
  successfulProposals   Int      @default(0)
  reputationScore       Int      @default(0)
  firstSeenAt           DateTime @default(now())
  lastActiveAt          DateTime @default(now())

  @@index([reputationScore])
}

// ----------------------------------------------------------------------------
// 7. SUPPORT SYSTEM (The Void)
// ----------------------------------------------------------------------------

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

model SupportTicket {
  id        String       @id @default(cuid())
  userId    String? // Optional: User might be anonymous or "Ghost"
  user      User?        @relation(fields: [userId], references: [walletAddress])
  section   String // 'general', 'technical', 'governance', 'other'
  message   String       @db.Text
  status    TicketStatus @default(OPEN)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Admin fields
  adminNotes String? @db.Text
  priority   String  @default("NORMAL")

  @@index([status])
  @@index([userId])
  @@index([createdAt])
}

// ----------------------------------------------------------------------------
// NEXTAUTH.JS MODELS (Google OAuth)
// ----------------------------------------------------------------------------

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [walletAddress], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model NextAuthSession {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [walletAddress], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Update User model to support OAuth
model User {
  walletAddress        String       @id
  worldIdNullifierHash String?      @unique
  email                String?      @unique
  tier                 IdentityTier @default(GHOST)
  reputation           Int          @default(0)
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
  lastActive           DateTime     @default(now())

  // NextAuth fields
  name          String?
  emailVerified DateTime?
  image         String?

  // Relaciones
  proposals       MarketProposal[]
  proposalVotes   ProposalVote[]
  zapTransactions ZapTransaction[]
  rewardClaims    RewardClaim[]
  metrics         UserMetrics?
  trades          Trade[]
  simpleVotes     Vote[]
  sessions        Session[]
  supportTickets  SupportTicket[]

  // NextAuth relations
  accounts         Account[]
  nextAuthSessions NextAuthSession[]

  // [NEW] Phase 1 Relations
  settings      UserSettings?
  contacts      Contact[]
  notifications Notification[]

  @@index([reputation])
}

// ----------------------------------------------------------------------------
// AUTH SYSTEM (Real Email Verification & Sessions)
// ----------------------------------------------------------------------------

model AuthUser {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String?
  verified     Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // [NEW] Internal Wallet Data
  walletAddress       String?  @unique
  encryptedMnemonic   String?  @db.Text
  encryptedPrivateKey String?  @db.Text
  walletSalt          String? 

  verificationCodes VerificationCode[]
  userSettings      UserSettings?
  contacts          UserContact[]
  notifications     UserNotification[]
  sessions          Session[]

  @@index([email])
}

model VerificationCode {
  id        String   @id @default(cuid())
  code      String
  userId    String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, code])
  @@index([expiresAt])
}

// ============================================================================
// PHASE 1: ADVANCED USER MANAGEMENT FEATURES
// ============================================================================

// ----------------------------------------------------------------------------
// EMAIL SUBSCRIPTIONS SYSTEM
// ----------------------------------------------------------------------------

model EmailSubscriber {
  id    String  @id @default(cuid())
  email String  @unique
  name  String?

  // Subscription status
  subscribed       Boolean @default(true)
  unsubscribeToken String  @unique @default(cuid())

  // Preferences
  frequency String   @default("weekly") // daily, weekly, monthly
  topics    String[] // ["updates", "news", "releases"]

  // Timestamps
  subscribedAt DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([email])
  @@index([subscribed])
}

// ----------------------------------------------------------------------------
// NEWS & UPDATES SYSTEM
// ----------------------------------------------------------------------------

model NewsUpdate {
  id          String @id @default(cuid())
  title       String
  description String
  content     String @db.Text
  category    String // "feature", "update", "announcement", "defi-news", "web3-news"

  // Media
  imageUrl  String?
  lottieUrl String?

  // Metadata
  author      String?
  publishedAt DateTime @default(now())
  featured    Boolean  @default(false)

  // SEO
  slug String   @unique
  tags String[]

  @@index([publishedAt])
  @@index([category])
  @@index([featured])
}

// ----------------------------------------------------------------------------
// USER SETTINGS (Persistent)
// ----------------------------------------------------------------------------

model UserSettings {
  id         String    @id @default(cuid())
  userId     String?   @unique
  authUserId String?   @unique
  user       User?     @relation(fields: [userId], references: [walletAddress], onDelete: Cascade)
  authUser   AuthUser? @relation(fields: [authUserId], references: [id], onDelete: Cascade)

  // Appearance
  theme    String @default("light") // light, dark, auto
  language String @default("es") // es, en, fr, etc

  // Privacy
  showProfile  Boolean @default(true)
  showActivity Boolean @default(false)

  // Notifications
  emailNotifications Boolean @default(true)
  pushNotifications  Boolean @default(true)
  transactionAlerts  Boolean @default(true)
  marketingEmails    Boolean @default(false)

  // Trading
  defaultSlippage     Float   @default(0.5)
  defaultGasPrice     String  @default("medium")
  confirmTransactions Boolean @default(true)

  // [NEW] Smart Wallet Security
  walletStealthMode         Boolean @default(false)
  requirePasswordForSigning Boolean @default(true)
  autoLockDuration          Int     @default(15) // minutes

  // Backup
  lastBackupAt    DateTime?
  backupFrequency String    @default("weekly") // daily, weekly, monthly

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ----------------------------------------------------------------------------
// CONTACTS MANAGEMENT
// ----------------------------------------------------------------------------

model Contact {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [walletAddress], onDelete: Cascade)

  // Contact Info
  name          String
  email         String?
  walletAddress String?
  ens           String?

  // Metadata
  notes    String?
  tags     String[] // ["friend", "business", "vip"]
  favorite Boolean  @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([walletAddress])
  @@index([favorite])
}

model UserContact {
  id         String   @id @default(cuid())
  authUserId String
  authUser   AuthUser @relation(fields: [authUserId], references: [id], onDelete: Cascade)

  // Contact Info
  name          String
  email         String?
  walletAddress String?
  ens           String?

  // Metadata
  notes    String?
  tags     String[] // ["friend", "business", "vip"]
  favorite Boolean  @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([authUserId])
  @@index([walletAddress])
  @@index([favorite])
}

// ----------------------------------------------------------------------------
// NOTIFICATIONS SYSTEM
// ----------------------------------------------------------------------------

model Notification {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [walletAddress], onDelete: Cascade)

  // Content
  title   String
  message String
  type    String // "transaction", "market", "system", "social"

  // Status
  read     Boolean @default(false)
  archived Boolean @default(false)

  // Metadata
  actionUrl String?
  metadata  Json?

  createdAt DateTime @default(now())

  @@index([userId, read])
  @@index([userId, createdAt])
}

model UserNotification {
  id         String   @id @default(cuid())
  authUserId String
  authUser   AuthUser @relation(fields: [authUserId], references: [id], onDelete: Cascade)

  // Content
  title   String
  message String
  type    String // "transaction", "market", "system", "social"

  // Status
  read     Boolean @default(false)
  archived Boolean @default(false)

  // Metadata
  actionUrl String?
  metadata  Json?

  createdAt DateTime @default(now())

  @@index([authUserId, read])
  @@index([authUserId, createdAt])
}
